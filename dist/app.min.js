
const nav = document.querySelector('nav[aria-label="Principal"]');
const burger = document.querySelector('.hamburger');
if (burger && nav){
  burger.addEventListener('click', ()=>{
    const open = nav.getAttribute('data-open') === 'true';
    nav.setAttribute('data-open', String(!open));
    burger.setAttribute('aria-expanded', String(!open));
  });
}
function onlyDigits(s){ return s.replace(/\D/g,''); }
function cpfMask(v){
  v = onlyDigits(v).slice(0,11);
  return v.replace(/(\d{3})(\d)/,'$1.$2')
          .replace(/(\d{3})(\d)/,'$1.$2')
          .replace(/(\d{3})(\d)/,'$1-$2');
}
function telMask(v){
  v = onlyDigits(v).slice(0,11);
  v = v.replace(/(\d{2})(\d)/,'($1) $2');
  v = v.replace(/(\d{5})(\d)/,'$1-$2');
  return v;
}
function cepMask(v){
  v = onlyDigits(v).slice(0,8);
  return v.replace(/(\d{5})(\d)/, '$1-$2');
}
function mask(el, formatter){ if(!el) return; el.addEventListener('input', () => el.value = formatter(el.value)); }
mask(document.getElementById('cpf'), cpfMask);
mask(document.getElementById('tel'), telMask);
mask(document.getElementById('cep'), cepMask);
const form = document.querySelector('form');
if (form){
  form.addEventListener('submit', (e)=>{
    if(!form.checkValidity()){
      e.preventDefault();
      const invalid = form.querySelector(':invalid');
      if (invalid) invalid.focus();
      alert('Por favor, corrija os campos destacados.');
    }
  });
}


// Configura máscaras, validação inline e storage das inscrições
(function(){
  function onlyDigits(s){ return s.replace(/\D/g,''); }
  function cpfMask(v){
    v = onlyDigits(v).slice(0,11);
    return v.replace(/(\d{3})(\d)/,'$1.$2')
            .replace(/(\d{3})(\d)/,'$1.$2')
            .replace(/(\d{3})(\d)/,'$1-$2');
  }
  function telMask(v){
    v = onlyDigits(v).slice(0,11);
    v = v.replace(/(\d{2})(\d)/,'($1) $2');
    v = v.replace(/(\d{5})(\d)/,'$1-$2');
    return v;
  }
  function cepMask(v){
    v = onlyDigits(v).slice(0,8);
    return v.replace(/(\d{5})(\d)/, '$1-$2');
  }
  function mask(el, formatter){ if(!el) return; el.addEventListener('input', () => el.value = formatter(el.value)); }

  // Feedback inline de validação
  function attachValidation(form){
    if(!form) return;
    form.querySelectorAll('input,select,textarea').forEach(el => {
      el.addEventListener('invalid', ()=>{
        let msg = el.validationMessage || 'Campo inválido.';
        showFieldError(el, msg);
      });
      el.addEventListener('input', ()=> clearFieldError(el));
      el.addEventListener('blur', ()=>{
        if (!el.checkValidity()) showFieldError(el, el.validationMessage);
        else clearFieldError(el);
      });
    });
    form.addEventListener('submit', (e)=>{
      if(!form.checkValidity()){
        e.preventDefault();
        const invalid = form.querySelector(':invalid');
        if (invalid) invalid.focus();
      } else {
        // Salvar mock da inscrição
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form).entries());
        const store = JSON.parse(localStorage.getItem('inscricoes') || '[]');
        store.push({...data, timestamp: new Date().toISOString()});
        localStorage.setItem('inscricoes', JSON.stringify(store));
        showToast('Cadastro enviado! Obrigado por se voluntariar ❤️', 'success');
        form.reset();
      }
    });
  }

  function showFieldError(el, msg){
    clearFieldError(el);
    el.setAttribute('aria-invalid','true');
    const small = document.createElement('div');
    small.className = 'ajuda';
    small.style.color = 'var(--danger-600)';
    small.textContent = msg;
    el.insertAdjacentElement('afterend', small);
  }
  function clearFieldError(el){
    el.removeAttribute('aria-invalid');
    const next = el.nextElementSibling;
    if (next && next.classList.contains('ajuda')){
      next.remove();
    }
  }

  // Toast simples
  function showToast(text, type='info'){
    let toast = document.getElementById('toast');
    if(!toast){
      toast = document.createElement('div');
      toast.id = 'toast';
      toast.style.position='fixed';
      toast.style.right='16px';
      toast.style.bottom='16px';
      toast.style.zIndex='9999';
      toast.style.padding='12px 16px';
      toast.style.borderRadius='8px';
      toast.style.background='var(--neutral-900)';
      toast.style.color='#fff';
      document.body.appendChild(toast);
    }
    toast.textContent = text;
    toast.style.opacity = '1';
    setTimeout(()=>{ toast.style.opacity='0'; }, 3000);
  }

  // Expor setup para reuso após SPA carregar
  window.setupForms = function(){
    const cpf = document.getElementById('cpf');
    const tel = document.getElementById('tel');
    const cep = document.getElementById('cep');
    mask(cpf, cpfMask);
    mask(tel, telMask);
    mask(cep, cepMask);
    attachValidation(document.querySelector('form'));
  }

  // Inicialização direta para páginas não-SPA
  document.addEventListener('DOMContentLoaded', window.setupForms);
})();


// SPA com fallback offline (sem servidor): usa window.SABERMAIS_TEMPLATES quando fetch não é possível.
(function(){
  const routes = {
    '': {file:'home.html', key:'home'},
    '/': {file:'home.html', key:'home'},
    '/home': {file:'home.html', key:'home'},
    '/projetos': {file:'projetos.html', key:'projetos'},
    '/cadastro': {file:'cadastro.html', key:'cadastro'}
  };

  async function load(route){
    const container = document.getElementById('app');
    if(!container) return;
    const info = routes[route] || routes['/home'];

    // Se for file:// ou não houver fetch permitido, usa fallback inline
    const isFile = location.protocol === 'file:';
    if (isFile && window.SABERMAIS_TEMPLATES){
      container.innerHTML = window.SABERMAIS_TEMPLATES[info.key] || '<div class="alert error">Template não encontrado.</div>';
      afterLoad();
      return;
    }

    try {
      const resp = await fetch(`templates/${info.file}`, {cache: 'no-cache'});
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const html = await resp.text();
      container.innerHTML = html;
      afterLoad();
    } catch(e){
      if (window.SABERMAIS_TEMPLATES && window.SABERMAIS_TEMPLATES[info.key]){
        container.innerHTML = window.SABERMAIS_TEMPLATES[info.key];
        afterLoad();
      } else {
        container.innerHTML = `<div class="alert error" role="alert">Não foi possível carregar o conteúdo.</div>`;
      }
    }
  }

  function afterLoad(){
    if (typeof window.setupForms === 'function') window.setupForms();
    window.scrollTo(0,0);
  }

  function parseRoute(){
    const hash = location.hash || '#/home';
    const route = hash.replace('#','');
    load(route);
  }

  window.addEventListener('hashchange', parseRoute);
  window.addEventListener('DOMContentLoaded', parseRoute);
})();


// Toggle entre claro, escuro e alto contraste, com persistência
(function(){
  const root = document.documentElement;
  const saved = localStorage.getItem('theme');
  if (saved) root.setAttribute('data-theme', saved);

  function setTheme(v){
    if (v) root.setAttribute('data-theme', v);
    else root.removeAttribute('data-theme');
    if (v) localStorage.setItem('theme', v); else localStorage.removeItem('theme');
  }

  window.addEventListener('DOMContentLoaded', ()=>{
    const clr = document.getElementById('theme-clear');
    const drk = document.getElementById('theme-dark');
    const hi  = document.getElementById('theme-contrast');
    if (clr) clr.addEventListener('click', ()=> setTheme(''));
    if (drk) drk.addEventListener('click', ()=> setTheme('dark'));
    if (hi)  hi.addEventListener('click', ()=> setTheme('contrast'));
  });
})();

window.SABERMAIS_TEMPLATES = {"home": "\n<section class=\"hero\" aria-labelledby=\"bemvindo\">\n  <div>\n    <h1 id=\"bemvindo\" style=\"font-size:var(--fs-900)\">SaberMais: Educação que transforma pelo ensino de exatas</h1>\n    <p>Promovemos oportunidades de aprendizado em <strong>Matemática, Física e Química</strong> para estudantes de comunidades, conectando voluntários, projetos e doações com transparência.</p>\n    <p><a class=\"cta\" href=\"#/projetos\">Conheça nossos projetos</a></p>\n  </div>\n  <img src=\"imagens/hero.svg\" alt=\"Alunos estudando conteúdos de exatas com apoio de voluntários.\">\n</section>\n\n<section aria-labelledby=\"impacto\">\n  <h2 id=\"impacto\" style=\"font-size:var(--fs-700)\">Nosso impacto</h2>\n  <div class=\"grid auto-fit\">\n    <article class=\"card\" aria-labelledby=\"m1\"><h3 id=\"m1\">+500 alunos</h3><p>Atendidos em oficinas e mentorias de exatas.</p></article>\n    <article class=\"card\" aria-labelledby=\"m2\"><h3 id=\"m2\">+120 voluntários</h3><p>Engajados em aulas, trilhas e correções.</p></article>\n    <article class=\"card\" aria-labelledby=\"m3\"><h3 id=\"m3\">Transparência</h3><p>Relatórios abertos e prestação de contas periódica.</p></article>\n  </div>\n</section>\n", "projetos": "\n<header>\n  <h1 style=\"font-size:var(--fs-700)\">Projetos sociais</h1>\n  <p>Veja como participar como <strong>voluntário</strong> e como <strong>doar</strong> para ampliar nosso alcance.</p>\n</header>\n\n<img src=\"imagens/projetos.svg\" alt=\"Ilustração de projetos em matemática, física e química.\" style=\"width:100%;height:auto;border-radius:1rem;border:2px solid var(--primary-600);margin:1rem 0;\">\n\n<section aria-labelledby=\"lista-projetos\" id=\"lista-projetos\">\n  <h2 id=\"lista-projetos\" style=\"font-size:var(--fs-600)\">Em andamento</h2>\n  <div class=\"grid auto-fit\">\n    <article class=\"card\">\n      <h3>Trilhas de Matemática</h3>\n      <p>Aulas semanais do básico ao ENEM, com monitorias e listas comentadas.</p>\n      <p><strong>Quando:</strong> Sábados • 9h–11h</p>\n      <span class=\"badge green\">Educação</span>\n    </article>\n    <article class=\"card\">\n      <h3>Laboratório de Química</h3>\n      <p>Experimentos seguros e contextualizados para turmas do ensino médio.</p>\n      <p><strong>Quando:</strong> Quartas • 14h–16h</p>\n      <span class=\"badge\">Ciência</span>\n    </article>\n    <article class=\"card\">\n      <h3>Física na Prática</h3>\n      <p>Oficinas com fenômenos e simulações acessíveis.</p>\n      <p><strong>Quando:</strong> Sextas • 15h–17h</p>\n      <span class=\"badge\">Extensão</span>\n    </article>\n  </div>\n</section>\n\n<section class=\"row\" aria-labelledby=\"como-participar\" id=\"como-participar\">\n  <h2 id=\"como-participar\" style=\"font-size:var(--fs-600)\">Como participar</h2>\n  <div>\n    <h3>Voluntariado</h3>\n    <p>Se você gosta de ensinar exatas, inscreva-se!</p>\n    <p><a class=\"btn\" href=\"#/cadastro\">Quero ser voluntário(a)</a></p>\n  </div>\n  <div>\n    <h3>Doações</h3>\n    <p>Contribua para materiais, transporte e lanches dos estudantes.</p>\n    <p><button class=\"btn secondary\" disabled aria-disabled=\"true\" title=\"Em breve\">Doar (em breve)</button></p>\n  </div>\n</section>\n", "cadastro": "\n<header>\n  <h1 style=\"font-size:var(--fs-700)\">Cadastro</h1>\n  <p>Preencha seus dados. Campos marcados com * são obrigatórios.</p>\n  <div class=\"alert info\" role=\"status\">Seus dados são usados apenas para contato e organização do voluntariado.</div>\n  <img src=\"imagens/cadastro.svg\" alt=\"Ilustração de cadastro de voluntários.\" style=\"width:100%;height:auto;border-radius:1rem;border:2px solid var(--primary-600);margin:1rem 0;\">\n</header>\n\n<form novalidate>\n  <fieldset>\n    <legend>Dados pessoais</legend>\n    <div class=\"row\">\n      <div>\n        <label for=\"nome\">Nome completo *</label>\n        <input type=\"text\" id=\"nome\" name=\"nome\" autocomplete=\"name\" required minlength=\"3\" placeholder=\"Seu nome completo\">\n      </div>\n      <div>\n        <label for=\"email\">E-mail *</label>\n        <input type=\"email\" id=\"email\" name=\"email\" autocomplete=\"email\" required placeholder=\"voce@exemplo.com\">\n      </div>\n    </div>\n    <div class=\"row\">\n      <div>\n        <label for=\"cpf\">CPF *</label>\n        <input type=\"text\" id=\"cpf\" name=\"cpf\" inputmode=\"numeric\" required\n               placeholder=\"000.000.000-00\"\n               pattern=\"\\d{3}\\.\\d{3}\\.\\d{3}-\\d{2}\"\n               title=\"Formato: 000.000.000-00\">\n      </div>\n      <div>\n        <label for=\"tel\">Telefone *</label>\n        <input type=\"tel\" id=\"tel\" name=\"tel\" inputmode=\"tel\" required\n               placeholder=\"(00) 00000-0000\"\n               pattern=\"\\(\\d{2}\\) \\d{5}-\\d{4}\"\n               title=\"Formato: (00) 00000-0000\">\n      </div>\n    </div>\n    <div class=\"row\">\n      <div>\n        <label for=\"nasc\">Data de nascimento *</label>\n        <input type=\"date\" id=\"nasc\" name=\"nasc\" required>\n      </div>\n    </div>\n  </fieldset>\n\n  <fieldset>\n    <legend>Endereço</legend>\n    <div class=\"row\">\n      <div>\n        <label for=\"end\">Endereço *</label>\n        <input type=\"text\" id=\"end\" name=\"end\" autocomplete=\"address-line1\" required placeholder=\"Rua, número, complemento\">\n      </div>\n      <div>\n        <label for=\"cep\">CEP *</label>\n        <input type=\"text\" id=\"cep\" name=\"cep\" inputmode=\"numeric\" required\n               placeholder=\"00000-000\"\n               pattern=\"\\d{5}-\\d{3}\"\n               title=\"Formato: 00000-000\">\n      </div>\n    </div>\n    <div class=\"row\">\n      <div>\n        <label for=\"cidade\">Cidade *</label>\n        <input type=\"text\" id=\"cidade\" name=\"cidade\" autocomplete=\"address-level2\" required>\n      </div>\n      <div>\n        <label for=\"estado\">Estado *</label>\n        <select id=\"estado\" name=\"estado\" autocomplete=\"address-level1\" required>\n          <option value=\"\" selected disabled>Selecione</option>\n          <option>AC</option><option>AL</option><option>AP</option><option>AM</option>\n          <option>BA</option><option>CE</option><option>DF</option><option>ES</option>\n          <option>GO</option><option>MA</option><option>MT</option><option>MS</option>\n          <option>MG</option><option>PA</option><option>PB</option><option>PR</option>\n          <option>PE</option><option>PI</option><option>RJ</option><option>RN</option>\n          <option>RS</option><option>RO</option><option>RR</option><option>SC</option>\n          <option>SP</option><option>SE</option><option>TO</option>\n        </select>\n      </div>\n    </div>\n  </fieldset>\n\n  <fieldset>\n    <legend>Interesse</legend>\n    <div class=\"row\">\n      <div>\n        <label for=\"area\">Área de interesse *</label>\n        <select id=\"area\" name=\"area\" required>\n          <option value=\"\" selected disabled>Selecione</option>\n          <option>Matemática</option>\n          <option>Física</option>\n          <option>Química</option>\n          <option>Mentorias</option>\n          <option>Comunicação</option>\n        </select>\n      </div>\n      <div>\n        <label for=\"disp\">Disponibilidade *</label>\n        <select id=\"disp\" name=\"disp\" required>\n          <option value=\"\" selected disabled>Selecione</option>\n          <option>Manhã</option>\n          <option>Tarde</option>\n          <option>Noite</option>\n          <option>Fins de semana</option>\n        </select>\n      </div>\n    </div>\n    <div>\n      <label for=\"mensagem\">Mensagem (opcional)</label>\n      <textarea id=\"mensagem\" name=\"mensagem\" rows=\"4\" placeholder=\"Conte um pouco sobre você.\"></textarea>\n    </div>\n  </fieldset>\n\n  <button class=\"btn\" type=\"submit\">Enviar cadastro</button>\n  <p class=\"ajuda\">As máscaras de CPF, telefone e CEP são aplicadas automaticamente ao digitar e a validação nativa do HTML5 confere o formato.</p>\n</form>\n"};
